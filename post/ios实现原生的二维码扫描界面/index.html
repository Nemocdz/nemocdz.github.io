<!DOCTYPE html>
<html lang="zh-cn">
<head>

  <meta charset="utf-8" />

  
  <title>iOS中实现原生的二维码扫描界面</title>

  
  




  
  <meta name="author" content="Nemocdz" />
  <meta name="description" content="二维码扫描是很多应用都会实现的功能，比较著名的第三方开源库是Google出品的ZXing，其的OC的移植版本是ZXingObjc。但是从iOS7开始，苹果就加入了原生Api的相机二维码扫描功能，而在iOS8中也加入了原生的从图片中识别二维码的功能，最近刚好接到一个需求开发一个二维码扫描的界面，把过程记录下来。

" />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Nemocdz" />
    <meta name="twitter:title" content="iOS中实现原生的二维码扫描界面" />
    <meta name="twitter:description" content="二维码扫描是很多应用都会实现的功能，比较著名的第三方开源库是Google出品的ZXing，其的OC的移植版本是ZXingObjc。但是从iOS7开始，苹果就加入了原生Api的相机二维码扫描功能，而在iOS8中也加入了原生的从图片中识别二维码的功能，最近刚好接到一个需求开发一个二维码扫描的界面，把过程记录下来。

" />
    <meta name="twitter:image" content="https://nemocdz.github.io/img/avatar.jpg" />
  




<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="https://nemocdz.github.io/post/ios%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%94%9F%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81%E6%89%AB%E6%8F%8F%E7%95%8C%E9%9D%A2/" />
<link rel="alternative" href="https://nemocdz.github.io/index.xml" title="Nemocdz&#39;s Blog" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />
<meta name="google-site-verification" content="ew6In8Dh7Hjg0Eozgh-VpZHVNe83XRZVOGwQSSAbrfw" />
<meta name="msvalidate.01" content="22596E34341DD1D17D6022C44647E587" />
<meta name="baidu-site-verification" content="iVpH4VhHBT" />




<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Nemocdz&#39;s Blog" />
<meta name="msapplication-tooltip" content="Nemocdz&#39;s Blog" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://nemocdz.github.io/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://nemocdz.github.io/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://nemocdz.github.io/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://nemocdz.github.io/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://nemocdz.github.io/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://nemocdz.github.io/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.1/video-js.min.css" />

<link rel="stylesheet" href="https://nemocdz.github.io/css/bundle.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.1/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/2014.01.31/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.0/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://nemocdz.github.io/img/avatar.png" alt="Avatar">
  
  <h2 class="title">Nemocdz&#39;s Blog</h2>
  
  <p class="subtitle">iOS&amp;Android Dev</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item  is-active"><a href="https://nemocdz.github.io/">首页</a></li>
      
        <li class="menu-item "><a href="https://nemocdz.github.io/about/">关于</a></li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:nemocdz@gmail.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/Nemocdz" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/Nemocdz" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      <li class="social-item">
        <a href="//www.instagram.com/Nemocdz" title="Instagram"><span class="icon icon-instagram"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="//weibo.com/Nemocdz" title="Weibo"><span class="icon icon-weibo"></span></a>
      </li>

      <li class="social-item">
        <a href="https://nemocdz.github.io/img/qrcode.jpg" title="Wechat"><span class="icon icon-wechat"></span></a>
      </li>

      

      <li class="social-item">
        <a href="//www.zhihu.com/people/nemocdz" title="Zhihu"><span class="icon icon-zhihu"></span></a>
      </li>

      

      

      <li class="social-item">
        <a href="https://nemocdz.github.io/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">iOS中实现原生的二维码扫描界面</h1>
      <p class="post-meta">@Nemocdz · Apr 21, 2017 · 4 min read</p>
    </header>
    <article class="post-content"><p>二维码扫描是很多应用都会实现的功能，比较著名的第三方开源库是Google出品的<a href="https://github.com/zxing/zxing">ZXing</a>，其的OC的移植版本是<a href="https://github.com/TheLevelUp/ZXingObjC">ZXingObjc</a>。但是从iOS7开始，苹果就加入了原生Api的相机二维码扫描功能，而在iOS8中也加入了原生的从图片中识别二维码的功能，最近刚好接到一个需求开发一个二维码扫描的界面，把过程记录下来。</p>

<p></p>

<p><img src="http://ww1.sinaimg.cn/large/006tNc79ly1feuhsfjbrsj30ku112q66.jpg" alt="IMG_0811" /></p>

<h3 id="相机扫描二维码部分">相机扫描二维码部分</h3>

<p>要调用系统的摄像头识别二维码，首先需要导入系统的AVFoundation库。其中我们用到最关键到类是AVCaptureSession。流程如下：</p>

<ul>
<li>初始化一个AVCaptureSession</li>
<li>设置其输入对象（从哪去捕获），设为设备输入</li>
<li>设置其输出对象（捕获哪些类型输出），设置输出类型的代理</li>
<li>设置相机图像层</li>
<li>调用Session的StartRuning方法开始捕获</li>
<li>在输出对象的代理方法里处理捕获的数据</li>
<li>调用Session的StopRuning方法停止捕获</li>
</ul>

<p>所以，新建一个ViewController，并加入以下属性。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">AVCaptureDeviceInput</span> <span class="o">*</span><span class="n">deviceInput</span><span class="p">;</span><span class="c1">//设备输入
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">AVCaptureMetadataOutput</span> <span class="o">*</span><span class="n">dataOutput</span><span class="p">;</span><span class="c1">//数据输出
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">AVCaptureSession</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span><span class="c1">//捕获会话任务
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">AVCaptureVideoPreviewLayer</span> <span class="o">*</span><span class="n">previewLayer</span><span class="p">;</span><span class="o">//</span><span class="err">相机图像层</span></code></pre></div>
<p>用懒加载分别初始化这些属性。输入很简单，代码如下。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">AVCaptureDeviceInput</span> <span class="o">*</span><span class="p">)</span><span class="nf">deviceInput</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_deviceInput</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
        <span class="n">AVCaptureDevice</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVCaptureDevice</span> <span class="nl">defaultDeviceWithMediaType</span><span class="p">:</span><span class="n">AVMediaTypeVideo</span><span class="p">];</span>
        <span class="n">_deviceInput</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVCaptureDeviceInput</span> <span class="nl">deviceInputWithDevice</span><span class="p">:</span><span class="n">device</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_deviceInput</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>输出方面，遵守AVCaptureMetadataOutputObjectsDelegate，并Delegate设置自己，回调线程设置为主线程就好。关于这个<code>-(void)setMetadataObjectsDelegate(id&lt;AVCaptureMetadataOutputObjectsDelegate&gt;)objectsDelegate queue:(dispatch_queue_t)objectsCallbackQueue;</code>方法，苹果的文档是这么解释的“客户端需要减少输出的元数据落下的可能性所以需要一个具体的队列来执行少量的加工和接收元数据的过程”，所以给一个串行队列就好了了，比如主队列。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">AVCaptureMetadataOutput</span> <span class="o">*</span><span class="p">)</span><span class="nf">dataOutput</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dataOutput</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_dataOutput</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVCaptureMetadataOutput</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
        <span class="p">[</span><span class="n">_dataOutput</span> <span class="nl">setMetadataObjectsDelegate</span><span class="p">:</span><span class="nb">self</span> <span class="nl">queue</span><span class="p">:</span><span class="n">dispatch_get_main_queue</span><span class="p">()];</span>
        <span class="n">_dataOutput</span><span class="p">.</span><span class="n">rectOfInterest</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">scanRectOfInterest</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_dataOutput</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>rectOfInterest属性是指扫描到区域。它是一个CGRect，但他是相对于相机的画面的大小的比例，有两个特殊之处：</p>

<ol>
<li>他的结构体4个值的范围都为0~1，也就是按照实际需要的x/相机画面宽度，y/相机画面高度，width/相机画面宽度，height/相机画面高度去赋值</li>
<li>他默认是横屏的，也就是结构体数值和平常用的Rect是xy相反的</li>
</ol>

<p>相机画面的大小由谁决定呢，由session的sessionPreset决定和previewLayer的videoGravity共同决定，sessionPreset值有很多种，高中低，还有下面这些等等</p>

<ul>
<li>AVCaptureSessionPreset320x240</li>
<li>AVCaptureSessionPreset352x288</li>
<li>AVCaptureSessionPreset640x480</li>
<li>AVCaptureSessionPreset960x540</li>
<li>AVCaptureSessionPreset1280x720</li>
<li>AVCaptureSessionPreset1920x1080</li>
</ul>

<p>这个就类似于image的大小，而videoGravity有这么几种</p>

<ul>
<li>AVCoreAnimationBeginTimeAtZero</li>
<li>AVLayerVideoGravityResizeAspect</li>
<li>AVLayerVideoGravityResizeAspectFill</li>
<li>AVLayerVideoGravityResize</li>
</ul>

<p>这个就类似于imageView的拉伸方式，而对于相机，我们当然不希望画面被拉伸压缩，也不希望上下有黑边，那么我们一般选AspectFill，也就是布满短边，而长边多的部分则取决于图片的长宽比。而相机画面大小就好比imageView的大小，那为了让这个可扫描的区域的rect和屏幕正常的Rect联系起来（方便对区域进行高亮之类的），我们当然希望这个image的长宽比和屏幕的长宽比一致咯，所以，对于4s一下的机型，因为屏幕是4:3的，我们采用AVCaptureSessionPreset640x480，而之后的，采用AVCaptureSessionPreset1920x1080。这样，既让画面没有拉伸，又把insertedRect和屏幕长宽正常的Rect对应了起来。</p>

<p>所以他的值时这样的</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nf">scanRectOfInterest</span><span class="p">{</span>
    <span class="n">CGRect</span> <span class="n">scanRect</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">scanRect</span><span class="p">];</span>
    <span class="n">scanRect</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="n">scanRect</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="o">/</span><span class="n">SCREEN_HEIGHT</span><span class="p">,</span> <span class="n">scanRect</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">scanRect</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="n">SCREEN_HEIGHT</span><span class="p">,</span><span class="n">scanRect</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="n">SCREEN_WIDTH</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">scanRect</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>然后就是Session，注意的地方是，dataoutput的metadataObjectTypes属性，也就是识别类型的设置，一定要在addOutput之后以及保证此时相机正常运行，权限不受限制的情况下设置，不然都会导致崩溃。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">AVCaptureSession</span> <span class="o">*</span><span class="p">)</span><span class="nf">session</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_session</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVCaptureSession</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
        <span class="p">[</span><span class="n">_session</span> <span class="nl">setSessionPreset</span><span class="p">:(</span><span class="n">SCREEN_HEIGHT</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">?</span> <span class="nl">AVCaptureSessionPreset640x480</span><span class="p">:</span><span class="n">AVCaptureSessionPreset1920x1080</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">_session</span> <span class="nl">canAddInput</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">deviceInput</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">_session</span> <span class="nl">addInput</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">deviceInput</span><span class="p">];</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">([</span><span class="n">_session</span> <span class="nl">canAddOutput</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">dataOutput</span><span class="p">]){</span>
            <span class="p">[</span><span class="n">_session</span> <span class="nl">addOutput</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">dataOutput</span><span class="p">];</span>
            <span class="nb">self</span><span class="p">.</span><span class="n">dataOutput</span><span class="p">.</span><span class="n">metadataObjectTypes</span> <span class="o">=</span> <span class="l">@[</span><span class="n">AVMetadataObjectTypeQRCode</span><span class="l">]</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_session</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>然后就是previewLayer</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">AVCaptureVideoPreviewLayer</span> <span class="o">*</span><span class="p">)</span><span class="nf">previewLayer</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_previewLayer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_previewLayer</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVCaptureVideoPreviewLayer</span> <span class="nl">layerWithSession</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span><span class="p">];</span>
        <span class="n">_previewLayer</span><span class="p">.</span><span class="n">videoGravity</span> <span class="o">=</span> <span class="n">AVLayerVideoGravityResizeAspectFill</span><span class="p">;</span>
        <span class="n">_previewLayer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="n">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_previewLayer</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>最后就是把图层加在view上并运行session，并在回调里处理扫描得到的元数据</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">startScan</span><span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">layer</span> <span class="nl">insertSublayer</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">previewLayer</span> <span class="nl">atIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="n">startRunning</span><span class="p">];</span>
<span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">captureOutput:</span><span class="p">(</span><span class="n">AVCaptureOutput</span> <span class="o">*</span><span class="p">)</span><span class="nv">captureOutput</span> <span class="nf">didOutputMetadataObjects:</span><span class="p">(</span><span class="n">NSArray</span><span class="o">&lt;</span><span class="n">AVMetadataMachineReadableCodeObject</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">metadataObjects</span> <span class="nf">fromConnection:</span><span class="p">(</span><span class="n">AVCaptureConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metadataObjects</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="n">stopRunning</span><span class="p">];</span>
 	<span class="n">NSString</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">metadataObjects</span><span class="p">.</span><span class="n">firstObject</span> <span class="n">stringValue</span><span class="p">];</span>
	<span class="c1">//信息处理
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<h3 id="识别相册图片中二维码">识别相册图片中二维码</h3>

<p>识别图片中的二维码就调用打开相册的接口，然后调用Core Image框架里的CIDetector类进行识别。CIDetector只能处理CIImage类，所以我们要对UIImage进行转换。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">messageFromQRCodeImage:</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nv">image</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//创建上下文
</span><span class="c1"></span>    <span class="n">CIContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIContext</span> <span class="nl">contextWithOptions</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="c1">//识别类型设置为二维码，精度设为高
</span><span class="c1"></span>    <span class="n">CIDetector</span> <span class="o">*</span><span class="n">detector</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIDetector</span> <span class="nl">detectorOfType</span><span class="p">:</span><span class="n">CIDetectorTypeQRCode</span> <span class="nl">context</span><span class="p">:</span><span class="n">context</span> <span class="nl">options</span><span class="p">:</span><span class="l">@{</span><span class="nl">CIDetectorAccuracy</span><span class="p">:</span><span class="n">CIDetectorAccuracyHigh</span><span class="l">}</span><span class="p">];</span>
  	<span class="c1">//转换image
</span><span class="c1"></span>    <span class="n">CIImage</span> <span class="o">*</span><span class="n">ciImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIImage</span> <span class="nl">imageWithCGImage</span><span class="p">:</span><span class="n">image</span><span class="p">.</span><span class="n">CGImage</span><span class="p">];</span>
  	<span class="c1">//获取识别结果
</span><span class="c1"></span>    <span class="n">NSArray</span> <span class="o">*</span><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">detector</span> <span class="nl">featuresInImage</span><span class="p">:</span><span class="n">ciImage</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">CIQRCodeFeature</span> <span class="o">*</span><span class="n">feature</span> <span class="o">=</span> <span class="n">features</span><span class="p">.</span><span class="n">firstObject</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">feature</span><span class="p">.</span><span class="n">messageString</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>而ImagePicker就是设置deleagate，并在回调里获取照片并调用上述方法处理了。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">UIImagePickerController</span> <span class="o">*</span><span class="p">)</span><span class="nf">imagePicker</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_imagePicker</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_imagePicker</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImagePickerController</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
        <span class="n">_imagePicker</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
        <span class="n">_imagePicker</span><span class="p">.</span><span class="n">sourceType</span> <span class="o">=</span> <span class="n">UIImagePickerControllerSourceTypePhotoLibrary</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_imagePicker</span><span class="p">;</span>
<span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">imagePickerController:</span><span class="p">(</span><span class="n">UIImagePickerController</span> <span class="o">*</span><span class="p">)</span><span class="nv">picker</span> <span class="nf">didFinishPickingMediaWithInfo:</span><span class="p">(</span><span class="n">nonnull</span> <span class="n">NSDictionary</span><span class="o">&lt;</span><span class="n">NSString</span> <span class="o">*</span><span class="p">,</span><span class="kt">id</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">info</span><span class="p">{</span>
    <span class="p">[</span><span class="n">picker</span> <span class="nl">dismissViewControllerAnimated</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">completion</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">UIImagePickerControllerOriginalImage</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">messageFromQRCodeImage</span><span class="p">:</span><span class="n">image</span><span class="p">];</span>
    <span class="c1">//信息处理
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>当然我们可以加一个导航栏上的按钮来调起相册。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">UIBarButtonItem</span> <span class="o">*</span><span class="n">libaryItem</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIBarButtonItem</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithTitle</span><span class="p">:</span><span class="s">@&#34;相册&#34;</span> <span class="nl">style</span><span class="p">:</span><span class="n">UIBarButtonItemStylePlain</span> <span class="nl">target</span><span class="p">:</span><span class="nb">self</span> <span class="nl">action</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">openLibary</span><span class="p">)];</span>
<span class="nb">self</span><span class="p">.</span><span class="n">navigationItem</span><span class="p">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">libaryItem</span><span class="p">;</span>
<span class="nb">self</span><span class="p">.</span><span class="n">navigationItem</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">navigationTitle</span><span class="p">;</span></code></pre></div>
<h3 id="增加非相机识别区域的压暗层">增加非相机识别区域的压暗层</h3>

<p>像微信一样，很多应用的二维码视图都有把除了扫描区域的外部区域的压暗层。这个压暗层就像一个镂空的图层一样，中间区域是没有的。我们可以用贝塞尔曲线绘制两个矩形路径，大矩形就是视图大小的矩形路径，小的就是扫描区域的路径。然后大路径去掉小路径，剩下部分就是一个镂空的视图区域的路径。并创建对应的layer。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nf">maskView</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_maskView</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_maskView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIView</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFrame</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">];</span>
        <span class="n">_maskView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">blackColor</span><span class="p">];</span>
        <span class="n">_maskView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span>
        <span class="n">UIBezierPath</span> <span class="o">*</span><span class="n">bpath</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIBezierPath</span> <span class="nl">bezierPathWithRect</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">SCREEN_HEIGHT</span><span class="p">)</span> <span class="p">];</span>
        <span class="p">[</span><span class="n">bpath</span> <span class="nl">appendPath</span><span class="p">:[[</span><span class="n">UIBezierPath</span> <span class="nl">bezierPathWithRect</span><span class="p">:[</span><span class="nb">self</span> <span class="n">scanRect</span><span class="p">]]</span> <span class="n">bezierPathByReversingPath</span><span class="p">]];</span>
        <span class="n">CAShapeLayer</span> <span class="o">*</span><span class="n">shapeLayer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CAShapeLayer</span> <span class="n">layer</span><span class="p">];</span>
        <span class="n">shapeLayer</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">bpath</span><span class="p">.</span><span class="n">CGPath</span><span class="p">;</span>
        <span class="n">_maskView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">shapeLayer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_maskView</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<h3 id="权限检查管理">权限检查管理</h3>

<p>基本功能实现后，可以考虑一下整个ViewController有没有会崩溃或者需要弹窗提示的地方。大概有以下这些情况</p>

<ul>
<li>相机是否存在</li>
<li>相机是否正常</li>
<li>相机权限</li>
<li>相册权限</li>
<li>图片中无二维码</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="c1">//相机是否存在，比如早期iPad，模拟器，itouch
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isCameraAvailable</span><span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">UIImagePickerController</span> <span class="nl">isSourceTypeAvailable</span><span class="p">:</span><span class="n">UIImagePickerControllerSourceTypeCamera</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">//前置摄像头是否正常
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isFrontCameraAvailable</span><span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">UIImagePickerController</span> <span class="nl">isCameraDeviceAvailable</span><span class="p">:</span><span class="n">UIImagePickerControllerCameraDeviceFront</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">//后置摄像头是否正常
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isRearCameraAvailable</span><span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">UIImagePickerController</span> <span class="nl">isCameraDeviceAvailable</span><span class="p">:</span><span class="n">UIImagePickerControllerCameraDeviceRear</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">//相机权限是否正常
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isCameraAuthStatusCorrect</span><span class="p">{</span>
    <span class="n">AVAuthorizationStatus</span> <span class="n">authStatus</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVCaptureDevice</span> <span class="nl">authorizationStatusForMediaType</span><span class="p">:</span><span class="n">AVMediaTypeVideo</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">authStatus</span> <span class="o">==</span> <span class="n">AVAuthorizationStatusAuthorized</span> <span class="o">||</span> <span class="n">authStatus</span> <span class="o">==</span> <span class="n">AVAuthorizationStatusNotDetermined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//相册权限是否正常，需要导入Photos框架
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isLibaryAuthStatusCorrect</span><span class="p">{</span>
    <span class="n">PHAuthorizationStatus</span> <span class="n">authStatus</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHPhotoLibrary</span> <span class="n">authorizationStatus</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">authStatus</span> <span class="o">==</span> <span class="n">PHAuthorizationStatusNotDetermined</span> <span class="o">||</span> <span class="n">authStatus</span> <span class="o">==</span> <span class="n">PHAuthorizationStatusAuthorized</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>当然在iOS10上，相机和相册权限还需要在infoPlist里添加对应的key值。</p>

<p><img src="http://ww4.sinaimg.cn/large/006tNc79ly1feuhsf3m30j30ri028t9e.jpg" alt="屏幕快照 2017-04-21 下午6.00.42" /></p>

<p>然后加上AlertViewController的弹窗。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showPermissionAlert</span><span class="p">{</span>
    <span class="n">UIAlertController</span> <span class="o">*</span><span class="n">alert</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertController</span> <span class="nl">alertControllerWithTitle</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">message</span><span class="p">:</span><span class="s">@&#34;需要相机/相册的权限&#34;</span> <span class="nl">preferredStyle</span><span class="p">:</span><span class="n">UIAlertControllerStyleAlert</span><span class="p">];</span>
    <span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">cancelAction</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertAction</span> <span class="nl">actionWithTitle</span><span class="p">:</span><span class="s">@&#34;取消&#34;</span> <span class="nl">style</span><span class="p">:</span><span class="n">UIAlertActionStyleCancel</span> <span class="nl">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">action</span><span class="p">){</span>
        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="nl">popViewControllerAnimated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">}];</span>
    <span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">requestAction</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertAction</span> <span class="nl">actionWithTitle</span><span class="p">:</span><span class="s">@&#34;同意&#34;</span> <span class="nl">style</span><span class="p">:</span><span class="n">UIAlertActionStyleDefault</span> <span class="nl">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">UIApplicationOpenSettingsURLString</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">([[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span><span class="nl">canOpenURL</span><span class="p">:</span><span class="n">url</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span><span class="nl">openURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}];</span>
    <span class="p">[</span><span class="n">alert</span> <span class="nl">addAction</span><span class="p">:</span><span class="n">cancelAction</span><span class="p">];</span>
    <span class="p">[</span><span class="n">alert</span> <span class="nl">addAction</span><span class="p">:</span><span class="n">requestAction</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">presentViewController</span><span class="p">:</span><span class="n">alert</span> <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">completion</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showWarn:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span> <span class="nf">shouldPop:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">pop</span><span class="p">{</span>
    <span class="n">UIAlertController</span> <span class="o">*</span><span class="n">alert</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertController</span> <span class="nl">alertControllerWithTitle</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">message</span><span class="p">:</span><span class="n">message</span> <span class="nl">preferredStyle</span><span class="p">:</span><span class="n">UIAlertControllerStyleAlert</span><span class="p">];</span>
    <span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">cancelAction</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertAction</span> <span class="nl">actionWithTitle</span><span class="p">:</span><span class="s">@&#34;好的&#34;</span> <span class="nl">style</span><span class="p">:</span><span class="n">UIAlertActionStyleCancel</span> <span class="nl">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">action</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="nl">popViewControllerAnimated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">}];</span>
    <span class="p">[</span><span class="n">alert</span> <span class="nl">addAction</span><span class="p">:</span><span class="n">cancelAction</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">presentViewController</span><span class="p">:</span><span class="n">alert</span> <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">completion</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span></code></pre></div>
<p>并加上权限检查</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">statusCheck</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isCameraAvailable</span><span class="p">]){</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">showWarn</span><span class="p">:</span><span class="s">@&#34;设备无相机&#34;</span> <span class="nl">shouldPop</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isRearCameraAvailable</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isFrontCameraAvailable</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">showWarn</span><span class="p">:</span><span class="s">@&#34;设备相机错误&#34;</span> <span class="nl">shouldPop</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isCameraAuthStatusCorrect</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">showPermissionAlert</span><span class="p">];</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">openLibary</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isLibaryAuthStatusCorrect</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">showPermissionAlert</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">presentViewController</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">imagePicker</span> <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">completion</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span></code></pre></div>
<h3 id="封装接口">封装接口</h3>

<p>最后一步了，对于这个ViewController我们需要开放什么接口对外呢，怎么把值传出去呢？外界可以改变的是扫描区域，标题，以及亚暗层的View（往上面加字等等），外界得到的结果应该是一个字符串。这里可以用Deleagte，头文件代码如下。</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">@protocol</span> <span class="nc">CDZQRCodeDelegate</span><span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
<span class="k">@required</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">pickUpMessage</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">message</span><span class="p">;</span>

<span class="k">@optional</span>
<span class="o">-</span> <span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="n">interestedRect</span><span class="p">;</span>

<span class="k">@end</span>
<span class="k">@interface</span> <span class="nc">CDZQRCodeViewController</span> : <span class="nc">UIViewController</span>

<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">weak</span><span class="p">)</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="n">CDZQRCodeDelegate</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">navigationTitle</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">maskView</span><span class="p">;</span>

<span class="k">@end</span></code></pre></div>
<p>默认实现一个可扫描范围</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nf">scanRect</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">interestedRect</span><span class="p">)])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="n">interestedRect</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">CGSize</span> <span class="n">scanSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="n">SCREEN_WIDTH</span> <span class="o">*</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">SCREEN_WIDTH</span> <span class="o">*</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">CGRect</span> <span class="n">scanRect</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">((</span><span class="n">SCREEN_WIDTH</span> <span class="o">-</span> <span class="n">scanSize</span><span class="p">.</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">SCREEN_HEIGHT</span> <span class="o">-</span> <span class="n">scanSize</span><span class="p">.</span><span class="n">height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">scanSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">scanSize</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">scanRect</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>并在相机和相册的回调里把结果通过回调传到外面</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">pickUpMessage</span><span class="p">:)])</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">pickUpMessage</span><span class="p">:</span><span class="n">result</span><span class="p">];</span>
<span class="p">}</span></code></pre></div>
<p>而别的VC调用就只需要遵守Delegate并</p>
<div class="highlight"><pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">selectScan:</span><span class="p">(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
    <span class="n">CDZQRCodeViewController</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CDZQRCodeViewController</span> <span class="n">alloc</span><span class="p">]</span><span class="n">init</span><span class="p">];</span>
    <span class="n">vc</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
    <span class="n">vc</span><span class="p">.</span><span class="n">navigationTitle</span> <span class="o">=</span> <span class="s">@&#34;自定义&#34;</span><span class="p">;</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="nl">pushViewController</span><span class="p">:</span><span class="n">vc</span> <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">pickUpMessage:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span><span class="p">{</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">resultLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<h3 id="最后">最后</h3>

<p>所有源码和<a href="https://github.com/Nemocdz/CDZQRScanView">Demo</a></p>

<p>使用时可以把VC两个文件拖进项目里就可。</p>

<p>如果您觉得有帮助,不妨给个star鼓励一下,欢迎关注&amp;交流</p></article>
    <footer class="post-footer">
      
      <p class="post-copyright">
        This post was published <strong>473</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-nemocdz-github-io-my-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2018 Nemocdz&#39;s Blog</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/Nemocdz/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script src="//cdn.bootcss.com/video.js/6.2.1/video.min.js"></script>
<script src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script src="https://nemocdz.github.io/js/bundle.js"></script>




  </body>
</html>
