---
title: "TCP/IP协议族边学边想"
date: 2017-08-22T03:28:20+08:00
draft: false
---

### 写在前面

最近读了《图解TCP/IP》这本书，重新理解了大二囫囵吞枣，应付考试而学习的“计算机网络”和“TCP/IP”这两门课中一些未理解的知识，和疑惑的问题。

### 网络基础

OSI七层模型

* 物理层-0和1代表高低电压，物理网络设备规格
* 数据链路层-数据帧和比特流转换
* 网络层-地址管理和路由选择
* 传输层-连接节点之间的数据传输
* 会话层-通信管理
* 表示层-数据格式转换
* 应用层-针对应用定制

TCP/IP：定义了数据链路层以上的协议，包括网络层、传输层、应用层（会话层以上都包括）

### 网络层

网络层只关心起终点的整体传输，数据链路层关心每一个设备间的传输。

#### IP（Internet Protocol）

Q：IP为何面向无连接？

A：1.简化 2.提速 3.为上层提供自定义

##### IP寻址

IP地址=网络标识+主机标识

Q：如何确定网络标识位数？

A：IP分类（传统ABCD）或子网掩码来划分

##### 路由控制

指明IP包的下一跳路由，用路由控制表保存信息。

形成方式

* 静态路由控制（管理员手动设置）
* 动态路由控制（和其他路由器交换信息自动刷新，受到“路由协议”控制）

路由聚合：多个子网掩码对外呈现同一网络地址，减少路由表条目

Q：0.0.0.0/0，IP地址/32，127.0.0.1分别是什么意思？

A：

1. 代表默认路由，路由表中任意的地址都能和它匹配，并不是一个IP地址（IP地址应标识为0.0.0.0/32）。匹配不到的都走默认路由。在家用路由器中用来描述Internet上所有的路由从而不用存储所有路由。
2. 代表主机路由，所有位都参与路由，代表某一个主机的唯一路由。可用于匹配家用路由器的默认路由的寻找。
3. 代表环回地址，同一计算机内的网络通信的本地默认地址，数据不会被流向网络。

##### IP包的分割和重组

在发送端和路由根据每段链路的MTU进行分片，接收端进行重组。

Q：为何传输过程需要分割数据包？

A：因为每种数据链路中的MTU（Max Transfer Unit，最大传输单元）各不相同

Q：为何只在接收端而不在途中重组？

A：

 	1. 无法保证分片在同一路径传输 
 	2. 分片可能丢失 
 	3. 可能之后还需要重新分片

分片机制的不足之处

* 路由器负荷加重
* 丢失某一分片整个IP包报废

###### 路径MTU发现

先获取整个路径中数据链路的最小MTU，发送端按照这个MTU分片

工作原理：

1. 先设置IP包禁止分片
2. 发送并在丢弃时（说明包MTU过大）将当时可最大的MTU用ICMP不可达消息返回
3. 设置包MTU为ICMP返回的MTU并重新循环上述步奏，直到无ICMP返回

##### IPv6

特点：

* 地址扩大，路由控制表的聚合
* 性能提升：不校验首部，简化首部建构
* 即插即用：无DHCP也可以实现自动分配IP
* 认证和加密：IPsec
* 多播和Mobile IP

#### DNS（Domain Name System）

将域名解析成IP。

各个域的分层有对应的域名服务器，像树一样连接分层，分别可以解析对应域名的IP。

工作原理：

1. 查询时先向该域内的域名服务器A查询，
2. 域名服务器A从下至上找到根域名服务器，
3. 根域名服务器再从上往下找到对应的域名服务器B地址并返回给域名服务器A
4. A向B查询域名的IP地址并返回。

#### ARP（Address Resolution Protocol）

通过目标IP地址定位下一个接收的网络设备MAC地址。分为请求和响应两部分。一般获取到Mac地址后会缓存一段时间。

#### ICMP（Internet Control Message Protocol）

主要功能

* 确认IP包是否成功送达
* 通知被废弃的具体原因

主要类型包括：目标不可达、重定向、超时、回送（Ping命令）

#### DHCP（Dynamic Host Configuratin Protocol）

为主机自动设置IP地址和统一管理IP地址分配。

工作原理：

1. 发送DHCP发现包（目标地址广播，源地址未知），请求网络设置（IP地址和子网掩码等）
2. DHCP服务器返回可使用的网络设置
3. 发送DHCP请求包（目标地址广播，源地址未知），通知想要应用该网络设置
4. DHCP服务器通知允许应用该设置

Q：为什么需要第二次通知和确认设置？

A：DHCP服务器的可分配目标地址可被管理员设置，二次确认可保证即使被重复的设置后也可以正常工作

Q：为什么DHCP服务器分配IP地址前发送ICMP、客户端应用获得的IP地址发前送ARP请求？

A：确认无返回应答从而检查IP地址是否可用，DHCP服务器发送ICMP是因为服务器少于客户端，ICMP速度更快，也不需要关心Mac地址

#### NAT（Network Address Translator）

用于将局域网中私有地址转换为全局IP地址的技术。

通过NAT路由器中维护一张自动生成的用来转换地址的表。

不同的内网主机可通过NAPT（Network Address Ports Translator）技术包含端口号一起转换。

IPv4和IPv6转换也可通过相关技术NAT-PT和NAPT-PT来实现

不足之处：

* 无法从NAT外部向内部建立连接
* 转换表生成和转换有开销
* 一旦异常需要重新启动时所有TCP连接会被重置


解决方式：IPv6或NAT穿透

#### IP隧道

在网络层首部后面继续追加网络层首部的通信方式

### 传输层

传输层通过端口号标识请求发送给哪一个应用程序的守护进程（对消息进行监听）。

标识唯一的通信的要素：源IP、目标IP、源端口号、目标端口号、协议号

#### UDP（User Datagram Protocol）

面向无连接的通信，不保证通信可靠，不负责丢包重发等。

主要用于高速传输和实时性要求较高的通信或广播：

* 包总量小（DNS等）
* 视频音频等多媒体通信（即时通信）
* 限定于LAN等特定网络
* 广播、多播通信

#### TCP（Transmission Control Protocol）

面向连接的通信，对传输、发送、通信进行控制，尽量保证通信可靠。

特点：通过序列号和确认应答（ACK）

Q：序列号作用是？

A：确认应答在途中被丢弃或者延迟到达，导致进行多次重传相同数据。序列号定义后可在确认应答中将下个应该发送的序列号带上，保证下次发送的是正确的。

Q：超时重发如何确定？

A：每次计算往返时间（RTT，Round Trip Time）和偏差（抖动值）相加并稍大一点

##### TCP连接建立和断开

设计思想我个人总结是：一次请求对应一次应答，**客户端和服务端都需要进行请求**。

Q：为啥建立连接是三次握手？

A：首先这三个包分别是

1. 客户端的请求（建立连接）
2. 客户端请求的应答+服务端请求 （建立连接）
3. 服务端请求的应答

也就是中间那个包实际上包含两个功能。

客户端和服务端都需要请求是因为建立连接前，两端配置（比如序列号）需要**协商同步**。

1. 同步信号需要一个**返回确保成功**，所以就有了请求的应答。
2. 单纯一边的请求和应答并不能保证另一边也达到同步，所以就需要两边都请求。

而三个包则是满足以上两个条件的**最小数字**。

Q：三次握手第三次失败了怎么办？

A：这时客户端已经进入Established状态，ACK若丢失并超时，服务端尝试重新发送（默认次数为5），间隔1秒开始，每次是前一次的2倍。若还未响应，则服务端会关闭连接。之后客户端向服务端发包，服务端则用RST（Reset）包回应告知错误，防止SYN洪泛攻击（不断向服务器建立半连接而不确认使服务器不断重发ACK消耗服务器资源）。

Q：为啥断开连接是四次挥手？

A：把步骤2拆开了，因为被动方不一定已经做好了断开的准备。

Q：四次挥手第四次失败了怎么办？

A：最后一个ACK发送后，主动请求一方会进入TIME_WAIT状态，等待2MSL（Maximum Segment Lifetime）后才进入CLOSE状态。被动方可在此时间内重发ACK，来尽可能确保最后一个ACK送达。

#### TCP窗口

每个请求包对应一个应答会随着数量增大和往返时间增长性能降低。

所以不需要每个包对应一个应答，而是以一个更大的单位。

窗口表示某些连续的包的集合，大小为无需确认应答而可以继续发送的最大值。

窗口需要缓存整个窗口的数据避免有一部分需要重传，直到收到应答后才可清除缓存。

Q：为何需要滑动窗口？

A：滑动窗口是指收到应答后将窗口滑动到确认应答里的序列号的位置。

* 可以迅速使后面进入窗口范围的数据也可同时发送，提高性能。
* 在收到包而应答丢失的情况，收到后面的应答可以表示之前的包收到了，滑动避免重传

Q：为何需要快速重传？

A：快速重传是指连续收到三次序号一致的之前序号应答后直接重传。因为丢失某个包后，后面的包也在窗口内所以也发送出去，此时会收到多次之前丢失包序号的应答，而不需要超时等待。之所以是三次参见[链接](https://www.zhihu.com/question/21789252)。

##### 窗口大小控制

过大容易造成接收方缓存区数据溢出，丢弃后造成无意义重传。

通过TCP首部的值进行动态大小控制。

Q：为何需要发送窗口探测包？

A：接收方缓存区即将满后会暂停接收并通知发送方暂停发送（窗口大小为0）。接收方可以重新开始接受时发送一个窗口更新包通知。避免此包丢失导致通信无法重新开始，发送端时不时发送窗口探测包来获取最新的窗口大小信息。

##### 拥塞控制

连接建立初期，突然发送大量数据容易造成网络瘫痪。

调节拥塞时发送大小的量，定义了“拥塞窗口”，让发送方窗口大小等于拥塞窗口。

设计思想：无拥塞则调大拥塞窗口，拥塞时马上减小窗口

慢启动算法：

1. 将拥塞窗口设置为1个MSS（Maximum Segment Size，最大数据段）
2. 开始窗口指数增长到慢启动阀值（第一次无限制）
3. 到达慢启动阀值后改为线性增长（除第一次）
4. 一旦发生超时则将慢启动阀值设置成当时的拥塞窗口大小的一半，并重新步骤1
5. 一旦发生重复确认应答则将慢启动阀值设置成当时拥塞窗口的一半，之后将拥塞窗口设置为慢启动阀值大小+3MSS，并重新步骤3

### 应用层

#### WWW基本概念

WWW=信息手段和位置-URI（Uniform Resource Identifer）+信息表现形式-HTML（HyperText Markup Language）+ 信息转发-HTTP（HyperText Transfer Protocol）

#### HTTP

主要有八种方法，常用的是GET和POST

Q：HTTP 1.0、1.1、2.0的不同之处？

A：1.0每次请求和应答都会使用新的TCP连接，1.1允许使用一个TCP连接，大幅减少断开和建立，提升性能。

2.0使用了多路复用、二进制分帧、首部压缩等技术进一步提升性能。详见[链接](https://www.zhihu.com/question/34074946)。

Q：GET和POST的不同之处？

A：设计的定义不同之处

* GET是幂等的（不改变数据）也不改变服务器状态的，POST非幂等且可改变服务器状态
* GET参数拼接在URL中，POST在HTTP请求头的Body中
* GET参数长度受到url长度的限制（取决于浏览器和服务器限制而非本身）

##### Cookie & Session

HTTP 是一种无状态的连接，客户端每次读取时，服务器都会认为这是一次新的会话。有时候需要持久保持某些信息，这些信息就由 Cookie 和 Session 保存。

Cookie 保存在客户端上，而 Session 则保存在服务器中。

当服务端接收到 Cookie 后，根据 SessionID 来查找。如果没有，则会生成一个新的 SessionID 发送给客户端。

#### HTTPS

HTTP协议在安全上存在三个风险：

* 明文传输-数据被窃听
* 不验证数据完整性-数据被篡改
* 不验证身份-冒充发送者身份通信

针对这三个风险，HTTPS分别做了处理：

* 窃听-加密报文
* 篡改-消息校验（Hash）
* 伪装-证书校验（证书验证链）

### 最后

TCP/IP每层都设计得巧妙，实用。了解了TCP/IP之后，对网络问题的思考会更加透彻。

















